{"version":3,"sources":["/Users/jshore/Documents/Projects/ergotest/src/tests/test_runner_worker_process.ts"],"sourcesContent":["// Copyright Titanium I.T. LLC. License granted under terms of \"The MIT License.\"\nimport { importRendererAsync, TestSuite } from \"./test_suite.js\";\nimport { TestCaseResult, TestMark, TestResult, TestSuiteResult } from \"./test_result.js\";\nimport { Clock } from \"../infrastructure/clock.js\";\nimport process from \"node:process\";\nimport { WorkerInput } from \"./test_runner.js\";\n\nconst KEEPALIVE_INTERVAL_IN_MS = 100;\n\nmain();\n\nfunction main() {\n\tconst cancelKeepAliveFn = Clock.create().repeat(KEEPALIVE_INTERVAL_IN_MS, () => {\n\t\tprocess.send!({ type: \"keepalive\" });\n\t});\n\n\tprocess.on(\"message\", (workerData) => {\n\t\trunWorkerAsync(cancelKeepAliveFn, workerData as WorkerInput);\n\t});\n\tprocess.on(\"error\", (err) => {\n\t\tif ((err as { code: string })?.code === \"ERR_IPC_CHANNEL_CLOSED\") {\n\t\t\tcancelKeepAliveFn();\n\t\t\tprocess.stdout.write(\n\t\t\t\t\"Ergotest worker process attempted to send message after IPC channel closed\\n\" +\n\t\t\t\t`Error: ${(err as Error)?.stack}`\n\t\t\t);\n\t\t}\n\t\telse {\n\t\t\tsendFatalError(\"Ergotest worker process generated 'error' event\", err, cancelKeepAliveFn);\n\t\t}\n\t});\n}\n\nasync function runWorkerAsync(\n\tcancelKeepAliveFn: () => void,\n\t{ modulePaths, timeout, config, renderer }: WorkerInput\n) {\n\ttry {\n\t\tconst renderError = await importRendererAsync(renderer);\n\n\t\tprocess.on(\"uncaughtException\", (err) => {\n\t\t\tconst errorResult = TestResult.suite([], [\n\t\t\t\tTestResult.fail(\"Unhandled error in tests\", err, undefined, TestMark.none, renderError),\n\t\t\t]);\n\t\t\tsendFinalResult(errorResult, cancelKeepAliveFn);\n\t\t});\n\n\t\tconst suite = await TestSuite.fromModulesAsync(modulePaths);\n\t\tconst result = await suite.runAsync({ timeout, config, renderer, onTestCaseResult: sendProgress });\n\n\t\t// wait a tick so unhandled promises can be detected\n\t\tsetImmediate(() => {\n\t\t\tsendFinalResult(result, cancelKeepAliveFn);\n\t\t});\n\t}\n\tcatch (err) {\n\t\tsendFatalError(\"Ergotest worker process encountered exception\", err, cancelKeepAliveFn);\n\t}\n}\n\nfunction sendProgress(result: TestCaseResult) {\n\tsend({\n\t\ttype: \"progress\",\n\t\tresult: result.serialize(),\n\t});\n}\n\nfunction sendFatalError(message: string, err: unknown, cancelKeepAliveFn: () => void) {\n\tcancelKeepAliveFn();\n\tsend({\n\t\ttype: \"fatal\",\n\t\tmessage,\n\t\terr,\n\t});\n}\n\nfunction sendFinalResult(result: TestSuiteResult, cancelKeepAliveFn: () => void) {\n\tcancelKeepAliveFn();\n\tsend({\n\t\ttype: \"complete\",\n\t\tresult: result.serialize(),\n\t});\n}\n\nfunction send(message: unknown) {\n\tprocess.send!(message);\n}"],"names":["importRendererAsync","TestSuite","TestMark","TestResult","Clock","process","KEEPALIVE_INTERVAL_IN_MS","main","cancelKeepAliveFn","create","repeat","send","type","on","workerData","runWorkerAsync","err","code","stdout","write","stack","sendFatalError","modulePaths","timeout","config","renderer","renderError","errorResult","suite","fail","undefined","none","sendFinalResult","fromModulesAsync","result","runAsync","onTestCaseResult","sendProgress","setImmediate","serialize","message"],"mappings":"AAAA,iFAAiF;AACjF,SAASA,mBAAmB,EAAEC,SAAS,QAAQ,kBAAkB;AACjE,SAAyBC,QAAQ,EAAEC,UAAU,QAAyB,mBAAmB;AACzF,SAASC,KAAK,QAAQ,6BAA6B;AACnD,OAAOC,aAAa,eAAe;AAGnC,MAAMC,2BAA2B;AAEjCC;AAEA,SAASA;IACR,MAAMC,oBAAoBJ,MAAMK,MAAM,GAAGC,MAAM,CAACJ,0BAA0B;QACzED,QAAQM,IAAI,CAAE;YAAEC,MAAM;QAAY;IACnC;IAEAP,QAAQQ,EAAE,CAAC,WAAW,CAACC;QACtBC,eAAeP,mBAAmBM;IACnC;IACAT,QAAQQ,EAAE,CAAC,SAAS,CAACG;QACpB,IAAI,AAACA,KAA0BC,SAAS,0BAA0B;YACjET;YACAH,QAAQa,MAAM,CAACC,KAAK,CACnB,iFACA,CAAC,OAAO,EAAGH,KAAeI,MAAM,CAAC;QAEnC,OACK;YACJC,eAAe,mDAAmDL,KAAKR;QACxE;IACD;AACD;AAEA,eAAeO,eACdP,iBAA6B,EAC7B,EAAEc,WAAW,EAAEC,OAAO,EAAEC,MAAM,EAAEC,QAAQ,EAAe;IAEvD,IAAI;QACH,MAAMC,cAAc,MAAM1B,oBAAoByB;QAE9CpB,QAAQQ,EAAE,CAAC,qBAAqB,CAACG;YAChC,MAAMW,cAAcxB,WAAWyB,KAAK,CAAC,EAAE,EAAE;gBACxCzB,WAAW0B,IAAI,CAAC,4BAA4Bb,KAAKc,WAAW5B,SAAS6B,IAAI,EAAEL;aAC3E;YACDM,gBAAgBL,aAAanB;QAC9B;QAEA,MAAMoB,QAAQ,MAAM3B,UAAUgC,gBAAgB,CAACX;QAC/C,MAAMY,SAAS,MAAMN,MAAMO,QAAQ,CAAC;YAAEZ;YAASC;YAAQC;YAAUW,kBAAkBC;QAAa;QAEhG,oDAAoD;QACpDC,aAAa;YACZN,gBAAgBE,QAAQ1B;QACzB;IACD,EACA,OAAOQ,KAAK;QACXK,eAAe,iDAAiDL,KAAKR;IACtE;AACD;AAEA,SAAS6B,aAAaH,MAAsB;IAC3CvB,KAAK;QACJC,MAAM;QACNsB,QAAQA,OAAOK,SAAS;IACzB;AACD;AAEA,SAASlB,eAAemB,OAAe,EAAExB,GAAY,EAAER,iBAA6B;IACnFA;IACAG,KAAK;QACJC,MAAM;QACN4B;QACAxB;IACD;AACD;AAEA,SAASgB,gBAAgBE,MAAuB,EAAE1B,iBAA6B;IAC9EA;IACAG,KAAK;QACJC,MAAM;QACNsB,QAAQA,OAAOK,SAAS;IACzB;AACD;AAEA,SAAS5B,KAAK6B,OAAgB;IAC7BnC,QAAQM,IAAI,CAAE6B;AACf"}