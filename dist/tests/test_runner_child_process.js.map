{"version":3,"sources":["/Users/jshore/Documents/Projects/ergotest/src/tests/test_runner_child_process.ts"],"sourcesContent":["// Copyright Titanium I.T. LLC. License granted under terms of \"The MIT License.\"\n\nimport { TestSuite } from \"./test_suite.js\";\nimport { TestCaseResult, TestResult, TestSuiteResult } from \"./test_result.js\";\nimport { Clock } from \"../infrastructure/clock.js\";\nimport process from \"node:process\";\nimport { WorkerInput } from \"./test_runner.js\";\n\nconst KEEPALIVE_INTERVAL_IN_MS = 100;\n\nmain();\n\nfunction main() {\n\tprocess.on(\"uncaughtException\", (err) => {\n\t\tconst errorResult = TestResult.suite([], [\n\t\t\tTestResult.fail(\"Unhandled error in tests\", err),\n\t\t]);\n\t\tsendFinalResult(errorResult);\n\t});\n\n\tClock.create().repeat(KEEPALIVE_INTERVAL_IN_MS, () => {\n\t\tprocess.send!({ type: \"keepalive\" });\n\t});\n\n\tprocess.on(\"message\", (workerData) => {\n\t\trunWorkerAsync(workerData as WorkerInput);\n\t});\n}\n\nasync function runWorkerAsync({ modulePaths, timeout, config }: WorkerInput) {\n\tconst suite = await TestSuite.fromModulesAsync(modulePaths);\n\tconst result = await suite.runAsync({ timeout, config, notifyFn: sendProgress });\n\n\t// wait a tick so unhandled promises can be detected\n\tsetImmediate(() => {\n\t\tsendFinalResult(result);\n\t});\n}\n\nfunction sendProgress(result: TestCaseResult) {\n\tprocess.send!({\n\t\ttype: \"progress\",\n\t\tresult: result.serialize(),\n\t});\n}\n\nfunction sendFinalResult(result: TestSuiteResult) {\n\tprocess.send!({\n\t\ttype: \"complete\",\n\t\tresult: result.serialize(),\n\t});\n}\n"],"names":["TestSuite","TestResult","Clock","process","KEEPALIVE_INTERVAL_IN_MS","main","on","err","errorResult","suite","fail","sendFinalResult","create","repeat","send","type","workerData","runWorkerAsync","modulePaths","timeout","config","fromModulesAsync","result","runAsync","notifyFn","sendProgress","setImmediate","serialize"],"mappings":"AAAA,iFAAiF;AAEjF,SAASA,SAAS,QAAQ,kBAAkB;AAC5C,SAAyBC,UAAU,QAAyB,mBAAmB;AAC/E,SAASC,KAAK,QAAQ,6BAA6B;AACnD,OAAOC,aAAa,eAAe;AAGnC,MAAMC,2BAA2B;AAEjCC;AAEA,SAASA;IACRF,QAAQG,EAAE,CAAC,qBAAqB,CAACC;QAChC,MAAMC,cAAcP,WAAWQ,KAAK,CAAC,EAAE,EAAE;YACxCR,WAAWS,IAAI,CAAC,4BAA4BH;SAC5C;QACDI,gBAAgBH;IACjB;IAEAN,MAAMU,MAAM,GAAGC,MAAM,CAACT,0BAA0B;QAC/CD,QAAQW,IAAI,CAAE;YAAEC,MAAM;QAAY;IACnC;IAEAZ,QAAQG,EAAE,CAAC,WAAW,CAACU;QACtBC,eAAeD;IAChB;AACD;AAEA,eAAeC,eAAe,EAAEC,WAAW,EAAEC,OAAO,EAAEC,MAAM,EAAe;IAC1E,MAAMX,QAAQ,MAAMT,UAAUqB,gBAAgB,CAACH;IAC/C,MAAMI,SAAS,MAAMb,MAAMc,QAAQ,CAAC;QAAEJ;QAASC;QAAQI,UAAUC;IAAa;IAE9E,oDAAoD;IACpDC,aAAa;QACZf,gBAAgBW;IACjB;AACD;AAEA,SAASG,aAAaH,MAAsB;IAC3CnB,QAAQW,IAAI,CAAE;QACbC,MAAM;QACNO,QAAQA,OAAOK,SAAS;IACzB;AACD;AAEA,SAAShB,gBAAgBW,MAAuB;IAC/CnB,QAAQW,IAAI,CAAE;QACbC,MAAM;QACNO,QAAQA,OAAOK,SAAS;IACzB;AACD"}