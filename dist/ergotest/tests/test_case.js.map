{"version":3,"sources":["/Users/jshore/Documents/Projects/ergotest/src/ergotest/tests/test_case.ts"],"sourcesContent":["// Copyright Titanium I.T. LLC. License granted under terms of \"The MIT License.\"\nimport { RunResult, TestCaseResult, TestMark, TestMarkValue, TestStatus } from \"../results/test_result.js\";\nimport * as ensure from \"../../util/ensure.js\";\nimport { RunData, RunOptions } from \"./test_suite.js\";\nimport { Runnable } from \"./runnable.js\";\nimport { BeforeAfter } from \"./before_after.js\";\nimport { Test } from \"./test.js\";\nimport { ItFn, ItOptions } from \"./test_api.js\";\n\nexport class TestCase implements Test {\n\n\tprotected readonly _name: string[];\n\tprivate readonly _mark: TestMarkValue;\n\tprivate readonly _fnAsync?: ItFn;\n\tprivate readonly _runnable: Runnable;\n\n\tstatic create({\n\t\tname,\n\t\tmark = TestMark.none,\n\t\toptions = {},\n\t\tfnAsync = undefined,\n\t}: {\n\t\tname: string[],\n\t\tmark?: TestMarkValue,\n\t\toptions?: ItOptions,\n\t\tfnAsync?: ItFn,\n\t}): TestCase {\n\t\treturn new TestCase(name, options, fnAsync, mark);\n\t}\n\n\tconstructor(\n\t\tname: string[],\n\t\toptions: ItOptions,\n\t\tfnAsync: ItFn | undefined,\n\t\tmark: TestMarkValue\n\t) {\n\t\tthis._name = name;\n\t\tthis._fnAsync = fnAsync;\n\t\tthis._runnable = Runnable.create(name, options, fnAsync);\n\n\t\tthis._mark = mark;\n\t\tif (fnAsync === undefined && mark === TestMark.none) this._mark = TestMark.skip;\n\t}\n\n\t/** @private */\n\t_isDotOnly(): boolean {\n\t\treturn this._mark === TestMark.only;\n\t}\n\n\t/** @private */\n\t_isSkipped(parentMark: TestMarkValue): boolean {\n\t\tconst inheritedMark = this._mark === TestMark.none ? parentMark : this._mark;\n\t\treturn inheritedMark === TestMark.skip || this._fnAsync === undefined;\n\t}\n\n\t/** @private */\n\tasync _runAsyncInternal(\n\t\trunOptions: RunOptions,\n\t\tparentData: RunData,\n\t): Promise<TestCaseResult> {\n\t\tconst runData = this.#consolidateRunData(parentData);\n\n\t\tconst beforeEach = await this.#runBeforeAfterEachAsync(runData.beforeEach, true, runOptions, runData);\n\t\tconst it = await this.#runTestAsync(runData, runOptions);\n\t\tconst afterEach = await this.#runBeforeAfterEachAsync(runData.afterEach, false, runOptions, runData);\n\n\t\tconst result = TestCaseResult.create({ mark: this._mark, beforeEach, afterEach, it });\n\t\trunOptions.onTestCaseResult(result);\n\t\treturn result;\n\t}\n\n\tasync #runTestAsync(runData: RunData, runOptions: RunOptions) {\n\t\tif (this._fnAsync === undefined && this._mark === TestMark.only) {\n\t\t\treturn RunResult.fail({\n\t\t\t\tname: this._name,\n\t\t\t\tfilename: runData.filename,\n\t\t\t\terror: \"Test is marked '.only', but it has no body\",\n\t\t\t\trenderError: runOptions.renderError,\n\t\t\t});\n\t\t}\n\n\t\treturn await this._runnable.runAsync(runOptions, runData);\n\t}\n\n\tasync #runBeforeAfterEachAsync(\n\t\tbeforeAfter: BeforeAfter[],\n\t\tisBeforeEach: boolean,\n\t\trunOptions: RunOptions,\n\t\trunData: RunData\n\t) {\n\t\tconst results = [];\n\t\tfor await (const test of beforeAfter) {\n\t\t\tconst result = await test.runBeforeAfterEachAsync(runOptions, runData);\n\t\t\tif (isBeforeEach && !isSuccess(result)) runData.skipAll = true;\n\t\t\tresults.push(result);\n\t\t}\n\t\treturn results;\n\t}\n\n\t#consolidateRunData(parentData: RunData): RunData {\n\t\treturn {\n\t\t\tfilename: parentData.filename,\n\t\t\tmark: this._mark === TestMark.none ? parentData.mark : this._mark,\n\t\t\ttimeout: parentData.timeout,\n\t\t\tskipAll: parentData.skipAll || this._isSkipped(parentData.mark),\n\t\t\tbeforeEach: parentData.beforeEach,\n\t\t\tafterEach: parentData.afterEach,\n\t\t};\n\t}\n\n}\n\n\n\nfunction isSuccess(result: TestCaseResult | RunResult) {\n\treturn result.status === TestStatus.pass || result.status === TestStatus.skip;\n}\n\n\n\n\nexport class FailureTestCase extends TestCase {\n\n\tprivate _filename?: string;\n\tprivate _error: unknown;\n\n\tconstructor(name: string[], error: unknown, filename?: string) {\n\t\tsuper(name, {}, undefined, TestMark.none);\n\n\t\tthis._filename = filename;\n\t\tthis._error = error;\n\t}\n\n\toverride async _runAsyncInternal(\n\t\trunOptions: RunOptions,\n\t\tparentData: RunData,\n\t): Promise<TestCaseResult> {\n\t\tconst it = RunResult.fail({\n\t\t\tname: this._name,\n\t\t\tfilename: this._filename,\n\t\t\terror: this._error,\n\t\t\trenderError: runOptions.renderError,\n\t\t});\n\t\tconst result = TestCaseResult.create({ mark: TestMark.none, it });\n\n\t\trunOptions.onTestCaseResult(result);\n\t\treturn await result;\n\t}\n\n}"],"names":["RunResult","TestCaseResult","TestMark","TestStatus","Runnable","TestCase","_name","_mark","_fnAsync","_runnable","create","name","mark","none","options","fnAsync","undefined","constructor","skip","_isDotOnly","only","_isSkipped","parentMark","inheritedMark","_runAsyncInternal","runOptions","parentData","runData","beforeEach","it","afterEach","result","onTestCaseResult","fail","filename","error","renderError","runAsync","beforeAfter","isBeforeEach","results","test","runBeforeAfterEachAsync","isSuccess","skipAll","push","timeout","status","pass","FailureTestCase","_filename","_error"],"mappings":"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"}