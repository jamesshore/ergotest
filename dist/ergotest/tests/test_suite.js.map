{"version":3,"sources":["/Users/jshore/Documents/Projects/ergotest/src/ergotest/tests/test_suite.ts"],"sourcesContent":["// Copyright Titanium I.T. LLC. License granted under terms of \"The MIT License.\"\nimport * as ensure from \"../../util/ensure.js\";\nimport { Clock } from \"../../infrastructure/clock.js\";\nimport {\n\tRenderErrorFn,\n\tTestCaseResult,\n\tTestMark,\n\tTestMarkValue,\n\tTestResult,\n\tTestStatus,\n\tTestSuiteResult,\n} from \"../results/test_result.js\";\nimport { BeforeAfter } from \"./before_after.js\";\nimport { Test } from \"./test.js\";\nimport { Milliseconds, TestOptions } from \"./test_api.js\";\n\nconst DEFAULT_TIMEOUT_IN_MS = 2000;\n\nexport interface TestConfig {\n\t[name: string]: unknown,\n}\n\nexport interface RunOptions {\n\tclock: Clock,\n\tonTestCaseResult: (testResult: TestCaseResult) => void,\n\tconfig: TestConfig,\n\trenderError?: RenderErrorFn,\n}\n\nexport interface RunData {\n\tfilename?: string;\n\tmark: TestMarkValue;\n\ttimeout: Milliseconds;\n\tskipAll: boolean;\n\tbeforeEach: BeforeAfter[];\n\tafterEach: BeforeAfter[];\n}\n\n/**\n * A simple but full-featured test runner.\n */\nexport class TestSuite implements Test {\n\n\tprivate _name: string[];\n\tprivate _mark: TestMarkValue;\n\tprivate _tests: Test[];\n\tprivate _hasDotOnlyChildren: boolean;\n\tprivate _allChildrenSkipped: boolean;\n\tprivate _beforeAll: BeforeAfter[];\n\tprivate _afterAll: BeforeAfter[];\n\tprivate _beforeEach: BeforeAfter[];\n\tprivate _afterEach: BeforeAfter[];\n\tprivate _timeout?: Milliseconds;\n\tprivate _filename?: string;\n\n\tstatic get DEFAULT_TIMEOUT_IN_MS() {\n\t\treturn DEFAULT_TIMEOUT_IN_MS;\n\t}\n\n\tstatic create({\n\t\tname = [],\n\t\tmark = TestMark.none,\n\t\ttimeout = undefined,\n\t\tbeforeAll = [],\n\t\tafterAll = [],\n\t\tbeforeEach = [],\n\t\tafterEach = [],\n\t\ttests = [],\n\t}: {\n\t\tname?: string[],\n\t\tmark?: TestMarkValue,\n\t\ttimeout?: Milliseconds,\n\t\tbeforeAll?: BeforeAfter[],\n\t\tafterAll?: BeforeAfter[],\n\t\tbeforeEach?: BeforeAfter[],\n\t\tafterEach?: BeforeAfter[],\n\t\ttests?: Test[],\n\t}) {\n\t\treturn new TestSuite(name, mark, timeout, beforeAll, afterAll, beforeEach, afterEach, tests);\n\t}\n\n\t/** Internal use only. (Use {@link describe} or {@link TestSuite.fromModulesAsync} instead.) */\n\tconstructor(\n\t\tname: string[],\n\t\tmark: TestMarkValue,\n\t\ttimeout: Milliseconds | undefined,\n\t\tbeforeAll: BeforeAfter[],\n\t\tafterAll: BeforeAfter[],\n\t\tbeforeEach: BeforeAfter[],\n\t\tafterEach: BeforeAfter[],\n\t\ttests: Test[],\n\t) {\n\t\tthis._name = name;\n\t\tthis._mark = mark;\n\t\tthis._timeout = timeout;\n\t\tthis._beforeAll = beforeAll;\n\t\tthis._afterAll = afterAll;\n\t\tthis._beforeEach = beforeEach;\n\t\tthis._afterEach = afterEach;\n\t\tthis._tests = tests;\n\t\tthis._hasDotOnlyChildren = this._tests.some(test => test._isDotOnly());\n\t\tthis._allChildrenSkipped = this._tests.every(test => test._isSkipped(this._mark));\n\t}\n\n\t/**\n\t * Run the tests in this suite.\n\t * @param {number} [timeout] Default timeout in milliseconds.\n\t * @param {object} [config={}] Configuration data to provide to tests.\n\t * @param {(result: TestResult) => ()} [onTestCaseResult] A function to call each time a test completes. The `result`\n\t *   parameter describes the result of the testâ€”whether it passed, failed, etc.\n\t * @param {string} [renderer] Path to a module that exports a `renderError()` function with the signature `(name:\n\t *   string, error: unknown, mark: TestMarkValue, filename?: string) => unknown`. The path must be an absolute path\n\t *   or a module that exists in `node_modules`. The `renderError()` function will be called when a test fails and the\n\t *   return value will be placed into the test result as {@link TestResult.errorRender}.\n\t * @param {Clock} [clock] Internal use only.\n\t * @returns {Promise<TestSuiteResult>} The results of the test suite.\n\t */\n\tasync runAsync({\n\t\ttimeout = DEFAULT_TIMEOUT_IN_MS,\n\t\tconfig = {},\n\t\tonTestCaseResult = () => {},\n\t\trenderer,\n\t\tclock = Clock.create(),\n\t}: TestOptions = {}): Promise<TestSuiteResult> {\n\t\tensure.signature(arguments, [[ undefined, {\n\t\t\ttimeout: [ undefined, Number ],\n\t\t\tconfig: [ undefined, Object ],\n\t\t\tonTestCaseResult: [ undefined, Function ],\n\t\t\trenderer: [ undefined, String ],\n\t\t\tclock: [ undefined, Clock ],\n\t\t}]]);\n\n\t\treturn await this._runAsyncInternal({\n\t\t\tclock,\n\t\t\tconfig,\n\t\t\tonTestCaseResult,\n\t\t\trenderError: await importRendererAsync(renderer),\n\t\t}, {\n\t\t\tmark: TestMark.only,\n\t\t\ttimeout: this._timeout ?? timeout,\n\t\t\tskipAll: false,\n\t\t\tbeforeEach: [],\n\t\t\tafterEach: [],\n\t\t});\n\t}\n\n\t/** @private */\n\t_setFilename(filename: string) { this._filename = filename; }\n\n\t/** @private */\n\t_isDotOnly(): boolean {\n\t\treturn this._mark === TestMark.only || this._hasDotOnlyChildren;\n\t}\n\n\t/** @private */\n\t_isSkipped(): boolean {\n\t\treturn this._allChildrenSkipped;\n\t}\n\n\t/** @private */\n\tasync _runAsyncInternal(runOptions: RunOptions, parentData: RunData) {\n\t\tconst runData = this.#consolidateRunData(parentData);\n\n\t\tconst beforeAllResults = await this.#runBeforeAfterAllAsync(this._beforeAll, true, runOptions, runData);\n\t\tconst testResults = await this.#runTestsAsync(runOptions, runData);\n\t\tconst afterAllResults = await this.#runBeforeAfterAllAsync(this._afterAll, false, runOptions, runData);\n\n\t\treturn TestSuiteResult.create({\n\t\t\tname: this._name,\n\t\t\tfilename: runData.filename,\n\t\t\tmark: this._mark,\n\t\t\ttests: testResults,\n\t\t\tbeforeAll: beforeAllResults,\n\t\t\tafterAll: afterAllResults,\n\t\t});\n\t}\n\n\tasync #runTestsAsync(runOptions: RunOptions, runData: RunData) {\n\t\tconst testResults = [];\n\t\tfor await (const test of this._tests) {\n\t\t\ttestResults.push(await test._runAsyncInternal(runOptions, runData));\n\t\t}\n\t\treturn testResults;\n\t}\n\n\tasync #runBeforeAfterAllAsync(\n\t\tbeforeAfter: BeforeAfter[],\n\t\tisBeforeAll: boolean,\n\t\trunOptions: RunOptions,\n\t\trunData: RunData\n\t) {\n\t\tconst results: TestCaseResult[] = [];\n\n\t\tfor await (const test of beforeAfter) {\n\t\t\tconst result = await test.runBeforeAfterAllAsync(runOptions, runData);\n\t\t\tif (isBeforeAll && !isSuccess(result)) runData.skipAll = true;\n\t\t\tresults.push(result);\n\t\t}\n\t\treturn results;\n\t}\n\n\t#consolidateRunData(parentData: RunData): RunData {\n\t\tconst beforeEach = [ ...parentData.beforeEach, ...this._beforeEach ];\n\t\tconst afterEach = [ ...this._afterEach, ...parentData.afterEach ];\n\n\t\tlet inheritedMark = this._mark;\n\t\tif (inheritedMark === TestMark.none) inheritedMark = parentData.mark;\n\t\tif (inheritedMark === TestMark.only && this._hasDotOnlyChildren) inheritedMark = TestMark.skip;\n\n\t\treturn {\n\t\t\tfilename: this._filename ?? parentData.filename,\n\t\t\tmark: inheritedMark,\n\t\t\ttimeout: this._timeout ?? parentData.timeout,\n\t\t\tskipAll: parentData.skipAll || this._isSkipped(),\n\t\t\tbeforeEach,\n\t\t\tafterEach,\n\t\t};\n\t}\n}\n\n\nfunction isSuccess(result: TestCaseResult) {\n\treturn result.status === TestStatus.pass || result.status === TestStatus.skip;\n}\n\n\n/** Internal use only. */\nexport async function importRendererAsync(renderer?: string) {\n\tif (renderer === undefined) return undefined;\n\n\ttry {\n\t\tconst { renderError } = await import(renderer);\n\t\tif (renderError === undefined) {\n\t\t\tthrow new Error(`Renderer module doesn't export a renderError() function: ${renderer}`);\n\t\t}\n\t\tif (typeof renderError !== \"function\") {\n\t\t\tthrow new Error(\n\t\t\t\t`Renderer module's 'renderError' export must be a function, but it was a ${typeof renderError}: ${renderer}`\n\t\t\t);\n\t\t}\n\t\treturn renderError;\n\t}\n\tcatch(err) {\n\t\tif (typeof err !== \"object\" || (err as { code: string })?.code !== \"ERR_MODULE_NOT_FOUND\") throw err;\n\t\tthrow new Error(`Renderer module not found (did you forget to use an absolute path?): ${renderer}`);\n\t}\n}"],"names":["ensure","Clock","TestMark","TestStatus","TestSuiteResult","DEFAULT_TIMEOUT_IN_MS","TestSuite","_name","_mark","_tests","_hasDotOnlyChildren","_allChildrenSkipped","_beforeAll","_afterAll","_beforeEach","_afterEach","_timeout","_filename","create","name","mark","none","timeout","undefined","beforeAll","afterAll","beforeEach","afterEach","tests","constructor","some","test","_isDotOnly","every","_isSkipped","runAsync","config","onTestCaseResult","renderer","clock","signature","arguments","Number","Object","Function","String","_runAsyncInternal","renderError","importRendererAsync","only","skipAll","_setFilename","filename","runOptions","parentData","runData","beforeAllResults","testResults","afterAllResults","push","beforeAfter","isBeforeAll","results","result","runBeforeAfterAllAsync","isSuccess","inheritedMark","skip","status","pass","Error","err","code"],"mappings":"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"}