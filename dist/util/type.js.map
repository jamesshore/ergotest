{"version":3,"sources":["/Users/jshore/Documents/Projects/ergotest/src/util/type.ts"],"sourcesContent":["// Copyright Titanium I.T. LLC. License granted under terms of \"The MIT License.\"\n\nimport arrayToSentence from \"array-to-sentence\";\n\nexport interface TypeOptions {\n\tname?: string;\n\tallowExtraKeys?: boolean;\n}\n\nexport interface DescribeOptions {\n\tarticles?: boolean;\n\tatLeast?: boolean;\n}\n\n// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\ntype SingleDescriptor = undefined | null | typeof NaN | Function;   // Descriptor can have any function as constructor\n\n// eslint-disable-next-line @typescript-eslint/no-empty-object-type\ninterface StructDescriptor extends Record<string, TypeDescriptor> {}  // required for circularity\n\nexport type TypeDescriptor = SingleDescriptor | TypeDescriptor[] | StructDescriptor;\n\nexport const ANY_TYPE = [ undefined, null, Boolean, Number, NaN, String, Object ];\n\nexport function check(arg: unknown, expectedTypes: TypeDescriptor, options?: TypeOptions): string | null {\n\tconst argType = getType(arg);\n\tif (!Array.isArray(expectedTypes)) expectedTypes = [ expectedTypes ];\n\toptions = options || {};\n\toptions.name = options.name || \"argument\";\n\n\tfor (let i = 0; i < expectedTypes.length; i++) {\n\t\tif (oneTypeMatches(arg, argType, expectedTypes[i])) {\n\t\t\tif (isStructComparison(argType, expectedTypes[i])) {\n\t\t\t\treturn checkStruct(arg as Record<string, unknown>, expectedTypes[i] as StructDescriptor, options);\n\t\t\t}\n\t\t\telse return null;\n\t\t}\n\t}\n\treturn describeError(arg, argType, expectedTypes, options.name, options.allowExtraKeys);\n\n\n\tfunction oneTypeMatches(arg: unknown, argType: TypeDescriptor, expectedType: TypeDescriptor) {\n\t\tif (argType === Object) return checkObject(arg, expectedType);\n\t\telse if (Number.isNaN(argType)) return Number.isNaN(expectedType);\n\t\telse return argType === expectedType;\n\n\t\tfunction checkObject(arg: unknown, type: TypeDescriptor) {\n\t\t\tif (type === null) return false;\n\t\t\telse if (typeof type === \"function\") return arg instanceof type;\n\t\t\telse if (typeof type === \"object\") return typeof arg === \"object\";\n\t\t\telse return false;\n\t\t}\n\t}\n\n\tfunction isStructComparison(argType: TypeDescriptor, type: TypeDescriptor) {\n\t\treturn argType === Object && typeof type === \"object\";\n\t}\n\n\tfunction checkStruct(arg: Record<string, unknown>, type: StructDescriptor, options: TypeOptions) {\n\t\tif (typeof type !== \"object\") throw new Error(\"unrecognized type: \" + type);\n\n\t\tconst unmatched = Object.assign({}, arg);\n\t\tconst keys = Object.getOwnPropertyNames(type);\n\t\tfor (let i = 0; i < keys.length; i++) {\n\t\t\tconst newOptions = Object.assign({}, options);\n\t\t\tconst key = keys[i]!;\n\t\t\tnewOptions.name = options.name + \".\" + key;\n\t\t\tconst checkResult = check(arg[key], type[key], newOptions);\n\t\t\tif (checkResult !== null) return checkResult;\n\t\t\tdelete unmatched[key];\n\t\t}\n\t\tif (!options.allowExtraKeys) {\n\t\t\tconst unmatchedKeys = Object.keys(unmatched);\n\t\t\tconst s = unmatchedKeys.length > 1 ? \"s\" : \"\";\n\t\t\tif (unmatchedKeys.length > 0) return `${options.name} had unexpected parameter${s}: ${unmatchedKeys.join(\", \")}`;\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tfunction describeError(\n\t\targ: unknown,\n\t\targType: TypeDescriptor,\n\t\ttype: TypeDescriptor,\n\t\tname: string,\n\t\tallowExtraKeys?: boolean,\n\t) {\n\t\tconst options = { articles: true, atLeast: allowExtraKeys };\n\t\tif (argType === Object && !isStruct(arg)) argType = arg as typeof Object;\n\t\treturn name + \" must be \" + describe(type, options) + \", but it was \" + describe(argType, options);\n\t}\n\n}\n\n\nexport function describe(type: TypeDescriptor, options: DescribeOptions = {}): string {\n\tif (!Array.isArray(type)) type = [ type ];\n\n\tconst descriptions = type.map(function(oneType) {\n\t\treturn describeOneType(oneType);\n\t});\n\tif (descriptions.length <= 2) return descriptions.join(\" or \");\n\telse return arrayToSentence(descriptions, { lastSeparator: \", or \" }); // dat Oxford comma\n\n\tfunction describeOneType(type: TypeDescriptor) {\n\t\tswitch(type) {\n\t\t\tcase Boolean: return options!.articles ? \"a boolean\" : \"boolean\";\n\t\t\tcase String: return options!.articles ? \"a string\" : \"string\";\n\t\t\tcase Number: return options!.articles ? \"a number\" : \"number\";\n\t\t\tcase Function: return options!.articles ? \"a function\" : \"function\";\n\t\t\tcase Array: return options!.articles ? \"an array\" : \"array\";\n\t\t\tcase undefined: return \"undefined\";\n\t\t\tcase null: return \"null\";\n\n\t\t\tdefault:\n\t\t\t\tif (Number.isNaN(type)) return \"NaN\";\n\t\t\t\telse if (typeof type === \"function\") return describeConstructor(type, options);\n\t\t\t\telse if (typeof type === \"object\") {\n\t\t\t\t\tif (isStruct(type)) return describeStruct(type as StructDescriptor, options);\n\t\t\t\t\telse return describeInstance(type, options);\n\t\t\t\t}\n\t\t\t\telse throw new Error(\"unrecognized type: \" + type);\n\t\t}\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\n\tfunction describeConstructor(type: Function, options: DescribeOptions) {  // can literally be any function\n\t\tconst articles = options.articles;\n\n\t\tif (type === Object) return articles ? \"an object\" : \"object\";\n\t\telse if (type === RegExp) return articles ? \"a regular expression\" : \"regular expression\";\n\n\t\tlet name = type.name;\n\t\tif (name) {\n\t\t\tif (articles) name = \"a \" + name;\n\t\t}\n\t\telse {\n\t\t\tname = articles ? \"an <anon>\" : \"<anon>\";\n\t\t}\n\t\treturn name + \" instance\";\n\t}\n\n\tfunction describeStruct(type: StructDescriptor, options: DescribeOptions) {\n\t\tconst properties = Object.getOwnPropertyNames(type).map(function(key) {\n\t\t\treturn key + \": <\" + describe(type[key]) + \">\";\n\t\t});\n\n\t\tconst objectDesc = options.articles ? \"an object\" : \"object\";\n\t\tif (properties.length === 0) {\n\t\t\treturn objectDesc;\n\t\t}\n\n\t\tconst atLeast = options.atLeast ? \"at least \" : \"\";\n\t\treturn objectDesc + ` containing ${atLeast}{ ${properties.join(\", \")} }`;\n\t}\n\n\tfunction describeInstance(type: object, options: DescribeOptions) {\n\t\tconst prototypeConstructor = Object.getPrototypeOf(type).constructor;\n\t\tconst article = options.articles;\n\t\tlet name = (article ? \"a \" : \"\") + prototypeConstructor.name;\n\t\tif (!prototypeConstructor.name) name = (article ? \"an \" : \"\") + \"<anon>\";\n\n\t\treturn name + \" instance\";\n\t}\n\n}\n\nfunction getType(variable: unknown): SingleDescriptor {\n\tif (variable === null) return null;\n\tif (Array.isArray(variable)) return Array;\n\tif (Number.isNaN(variable)) return NaN;\n\n\tswitch (typeof variable) {\n\t\tcase \"boolean\": return Boolean;\n\t\tcase \"string\": return String;\n\t\tcase \"number\": return Number;\n\t\tcase \"function\": return Function;\n\t\tcase \"object\": return Object;\n\t\tcase \"undefined\": return undefined;\n\n\t\tdefault:\n\t\t\tthrow new Error(\"Unreachable code executed. Unknown typeof value: \" + typeof variable);\n\t}\n}\n\nfunction isStruct(type: unknown): boolean {\n\tconst prototype = Object.getPrototypeOf(type);\n\treturn (!prototype || prototype.constructor === Object);\n}\n"],"names":["arrayToSentence","ANY_TYPE","undefined","Boolean","Number","NaN","String","Object","check","arg","expectedTypes","options","argType","getType","Array","isArray","name","i","length","oneTypeMatches","isStructComparison","checkStruct","describeError","allowExtraKeys","expectedType","checkObject","isNaN","type","Error","unmatched","assign","keys","getOwnPropertyNames","newOptions","key","checkResult","unmatchedKeys","s","join","articles","atLeast","isStruct","describe","descriptions","map","oneType","describeOneType","lastSeparator","Function","describeConstructor","describeStruct","describeInstance","RegExp","properties","objectDesc","prototypeConstructor","getPrototypeOf","constructor","article","variable","prototype"],"mappings":"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"}